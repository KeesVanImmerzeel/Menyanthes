get_dGG_over_layers <- function(pb_name, x) {
xd <- x %>% dplyr::filter(NAME == pb_name)
n <- nrow(xd) # aantal filters van de peilbuis met de naam pb_name
d_GG_pk_ST <-
NA # Stijghoogteverschil GG over Peelo kleivolgens SkyTem
d_GG_pz_ST <-
NA # Stijghoogteverschil in Peelo zand volgens SkyTem
d_GG_pk1_REG <-
NA # Stijghoogteverschil over Peelo klei 1 volgens Regis.
d_GG_pk2_REG <-
NA # Stijghoogteverschil over Peelo klei 2 volgens Regis.
d_GG_pz1_REG <-
NA # Stijghoogteverschil in Peelo zand 1 volgens Regis.
d_GG_pz2_REG <-
NA # Stijghoogteverschil in Peelo zand 2 volgens Regis.
d_GG_pz3_REG <-
NA # Stijghoogteverschil in Peelo klei 3 volgens Regis.
if (n > 1) {
# Verwijder waarnemingen van filters boven de keileem
i <- which(xd$kl_TNO > 0)
if (length(i) > 0) {
xd <- xd[-c(i),]
}
# Bereken stijghoogteverschil GG over Peelo volgens SkyTem
i <- which((xd$p1_2_ST > 0) | (xd$pk1_ST > 0))
if (length(i) > 0) {
j <- which((xd$p1_2_ST < 0) | (xd$pk1_ST < 0))
if (length(j) > 0) {
d_GG_pk_ST <- xd$GG[max(i)] - xd$GG[min(j)]
}
}
# Bereken stijghoogteverschil over Peelo zand vlgs SkyTem
i <- which(xd$pz_ST == 0)
if (length(i) > 1) {
d_GG_pz_ST <- xd$GG[max(i)] - xd$GG[min(i)]
}
# Bereken Stijghoogteverschil over Peelo klei 1 volgens Regis.
i <- which(xd$pk1_REG > 0)
if (length(i) > 0) {
j <- which(xd$pk1_REG < 0)
if (length(j) > 0) {
d_GG_pk1_REG <- xd$GG[max(i)] - xd$GG[min(j)]
}
}
# Bereken stijghoogteverschil over Peelo klei 2 volgens Regis
i <- which(xd$pk2_REG > 0)
if (length(i) > 0) {
j <- which(xd$pk2_REG < 0)
if (length(j) > 0) {
d_GG_pk2_REG <- xd$GG[max(i)] - xd$GG[min(j)]
}
}
# Bereken stijghoogteverschil over Peelo zand 1 vlgs Regis
i <- which(xd$pz1_REG == 0)
if (length(i) > 1) {
d_GG_pz1_REG <- xd$GG[max(i)] - xd$GG[min(i)]
}
# Bereken stijghoogteverschil over Peelo zand 2 vlgs Regis
i <- which(xd$pz2_REG == 0)
if (length(i) > 1) {
d_GG_pz2_REG <- xd$GG[max(i)] - xd$GG[min(i)]
}
# Bereken stijghoogteverschil over Peelo zand 3 vlgs Regis
i <- which(xd$pz3_REG == 0)
if (length(i) > 1) {
d_GG_pz3_REG <- xd$GG[max(i)] - xd$GG[min(i)]
}
} # twee of meer filters
res <-
data.frame(
d_GG_pk_ST = d_GG_pk_ST,
d_GG_pz_ST = d_GG_pz_ST,
d_GG_pk1_REG = d_GG_pk1_REG, #d_GG_pk1_R
d_GG_pk2_REG = d_GG_pk2_REG, #d_GG_pk2_R
d_GG_pz1_REG = d_GG_pz1_REG, #d_GG_pz1_R
d_GG_pz2_REG = d_GG_pz2_REG, #d_GG_pz2_R
d_GG_pz3_REG = d_GG_pz3_REG
)
return(res)
}
pb_names <- unique(p@data$NAME) %>% sort() %>% as.array()
res <- apply(pb_names,1,get_dGG_over_layers,x=p@data) %>% Reduce(rbind,.)
res$NAME <- pb_names
df <- suppressWarnings( dplyr::left_join(p@data, res) )
xy <- p@coords %>% as.data.frame()
df$X <- xy$coords.x1
df$Y <- xy$coords.x2
cnames <- c("NAME", "X", "Y", "d_GG_pk_ST","d_GG_pz_ST", "d_GG_pk1_REG", "d_GG_pk2_REG", "d_GG_pz1_REG", "d_GG_pz2_REG", "d_GG_pz3_REG")
df <-df[,cnames] %>% dplyr::distinct()
# Maak shape file van het resultaat.
sp::coordinates(df) <- ~ X + Y   # Voeg coordinaten toe aan dataframe
proj4string(df) <- crsAfoort
# Write resulting point shape
raster::shapefile(x=df, filename="dh_over_layers_Peilbuizen_provDrenthe_in_Sky_Tem.shp", overwrite = TRUE)
zand_van_tot <- function(pb_name, x) {
print(pb_name)
xd <- x %>% dplyr::filter(NAME == pb_name)
van_i <- NA
tot_i <- NA
i <-
which(!(xd$GRONDSOORT == "Zand" |
xd$GRONDSOORT == "Grind")) # i: index van bodemlagen niet gelijk aan zand/grind
if (length(i) == 0) {
# Alleen maar zand of grind
van_i <- 1
tot_i <- length(xd)
} else if (length(i) != nrow(xd)) {
# Als niet alle bodemlagen wat anders bevatten dan zand/grind
j <-
dplyr::lead(i) == (i + 1) # TRUE als lagen na i ook niet gelijk aan zand/grind
van_i <- i[which((j == FALSE) | (is.na(j)))] + 1
van_i <- van_i[van_i <= nrow(xd)]
i <- which(xd$GRONDSOORT == "Zand" | xd$GRONDSOORT == "Grind")
if (length(i) != 0) {
if (i[1] == 1) {
van_i <- c(1, van_i)
}
j <- dplyr::lead(i) == (i + 1)
tot_i <- i[which((j == FALSE) | (is.na(j)))]
tot_i <- tot_i[tot_i <= nrow(xd)]
}
}
res <- data.frame(NAME = pb_name,
X = xd$X[van_i],
Y = xd$Y[van_i],
VAN = xd$VAN[van_i],
TOT = xd$TOT[tot_i])
return(res)
}
lees_boring_csv <- function(fname) {
x <-
read.csv(
fname,
header = TRUE,
dec = ",",
sep = ";",
blank.lines.skip = TRUE,
stringsAsFactors = FALSE
)
x %<>% .[,-c(5:17, 21:26)]
colnames(x) <-
c("NAME", "X", "Y", "MV",
"VAN",
"TOT",
"GRONDSOORT")
x$GRONDSOORT %<>% trim()
x %<>% dplyr::filter(!is.na(MV))
x %<>% dplyr::filter(!is.na(VAN))
x %<>% dplyr::filter(!is.na(TOT))
x %<>% dplyr::filter(!is.na(GRONDSOORT))
x$X %<>% as.numeric()
x$Y %<>% as.numeric()
x$MV %<>% as.numeric()
invalid_name <- x$NAME[grep("-[0-9][0-9]$",x$NAME)] # Filter namen xxx_01 etc eruit (dubbele informatie)
x %<>% dplyr::filter(!NAME %in% invalid_name)
x$VAN <- x$MV - x$VAN
x$TOT <- x$MV - x$TOT
return(x)
}
fname <- "Topsoil_boring"
x <- lees_boring_csv(fname)
# Geef VAN / TOT waarden van de niveau's waar in de boorbeschrijving zand voorkomt van peilbuis pb_name.
pb_names <- unique(x$NAME) %>% sort() %>% as.array()
x <- apply(pb_names,1,zand_van_tot,x=x) %>% Reduce(rbind,.)
# Read shapefile van de peilbuizen met stijghoogte gegevens
p <- raster::shapefile("Peilbuizen_provDrenthe_in_Sky_Tem.shp")
# Combineer stijghoogtegegevens (p@data) met boorgegevens (x) --> data.frame "df"
df <- dplyr::inner_join(p@data,x)
str(df)
df$RL <- mapply(get_rl_code, df$TOP, df$BOT, df$VAN, df$TOT, SIMPLIFY = TRUE, USE.NAMES=FALSE)
# Bereken stijghoogteverschil tussen eerste en laatste filter in zandlagen van peilbuis "pb_name".
# df: data.frame met stijghoogtegegevens en boorgegevens (zie hierboven), met code "RL toegevoegd" en gefilterd op
# filters die in het zand liggen
get_dGG_in_sand <- function( pb_name, df ){
print(pb_name)
X <- NA
Y <- NA
F1_SND <- NA
F2_SND <- NA
D_GG_SND <- NA
xd <- df %>% dplyr::filter(NAME == pb_name)
n <- nrow(xd)
if (!is.na(n) & n>1) {
F1_SND <- xd$FILTER[1]
F2_SND <- xd$FILTER[n]
D_GG_SND <- xd$GG[1] - xd$GG[n]
}
res <- data.frame(NAME=pb_name,X=xd$X[1], Y=xd$Y[1], F1_SND=F1_SND,F2_SND=F2_SND,D_GG_SND=D_GG_SND)
return(res)
}
# Bereken voor alle peilbuizen de stijghoogteverschillen tussen eerste en laatste filter in zandlagen van peilbuis "pb_name".
# (Zie function "get_dGG_in_sand").
# Selecteer eerst de filters die geheel in een zandlaag liggen (RL==0).
df %<>% dplyr::filter(RL==0)
pb_names <- unique(df$NAME) %>% sort() %>% as.array()
res <- apply(pb_names,1,get_dGG_in_sand,df=df) %>% Reduce(rbind,.)
# Verwijder in het resultaat de records waar geen stijghoogteverschil berekend kon worden (aantal filters < 2).
nok <- is.na(res$D_GG_SND)
res <- res[!nok,]
# Maak shape file van het resultaat.
sp::coordinates(res) <- ~ X + Y   # Voeg coordinaten toe aan dataframe
proj4string(res) <- crsAfoort
# Write resulting point shape
raster::shapefile(x=res, filename="dh_over_sand_layers_Peilbuizen_provDrenthe_in_Sky_Tem.shp", overwrite = TRUE)
plot(res)
head(res@data)
library(devtools)
load_all()
fname <- system.file("extdata","export_data_menyanthes.csv",package="menyanthes")
hm <- hm_read_export_csv( fname )
str(hm$xd)
hm$xd %<>% dplyr::distinct(NAME,FILTER,DATE, .keep_all = TRUE)
#Verwijder peilbuizen uit meta data waar geen stijghoogten bekend zijn in de gefilterde stijghoogte gegevens
hm$xm %<>% dplyr::semi_join(unique(hm$xd[,c('NAME','FILTER')]))
head(hm$xm,20)
head(hm$xd,20)
document()
document()
library(menyanthes)
document()
load_all()
hm_clean <- hm_rm_fltrs_with_no_obs( hm )
str(hm$xm)
str(hm$xd)
hm <- hm_read_export_csv( fname )
load_all()
hm_filtered <- hm_filter_on_year( hm, minyear=2000)
load_all()
#Verwijder peilbuizen uit meta data waar geen stijghoogten bekend zijn in de gefilterde stijghoogte gegevens
hm %<>% hm_rm_fltrs_with_no_obs()
hm$xd
hm_clean <- hm_rm_fltrs_with_no_obs( hm )
hm$xm
document()
library(menyanthes)
library(devtools)
document()
library(menyanthes)
library(menyanthes)
?menyanthes
documnt()
document()
library(devtools)
document()
library(menyanthes)
library(devtools)
use_package("raster")
use_package(sp)
crsAfoort <- sp::CRS("+init=epsg:28992") # epsg projection 28992 - amersfoort
devtools::use_data(crsAfoort,internal=TRUE)
use_data(crsAfoort,internal=TRUE)
path.expand("~")
file.path("~","filename.shp")
"~" %>% path.expand() %>% file.path("filename.shp")
normalizePath("~","filename.shp")
normalizePath("~")
file.path(path.expand("~"),"filename.shp")
document()
library(menyanthes)
use_package("sp")
document()
library(menyanthes)
?proj4string
use_package("rgdal")
document()
document()
library(menyanthes)
library(menyanthes)
document()
library(menyanthes)
#library(dplyr)
#library(lubridate)
library(magrittr)
library(raster)
setwd("P:/410/372786_Update_Effectanalyse_Drentse_Weg/2. Do Work/Ontvangen gegevens/Peilbuizen/Meetnet_NMM")
hm <- readRDS("hm.rds")
# Maak plots van de gegevens
plts <- hm %>% menyanthes::hm_plot()
str(plts)
plts$NAME
plts$plots
load_all()
library(devtools)
load_all()
fname <- system.file("extdata","export_data_menyanthes.csv",package="menyanthes")
hm <- hm_read_export_csv( fname )
hm$xd$FILTER %<>% as.factor()
hm$xd %>% dplyr::group_by(NAME)
test <-   suppressWarnings(
hm$xd %>% dplyr::group_by(NAME) %>% dplyr::do(
plots = ggplot2::ggplot(data = .) +
ggplot2::aes(x = DATE, y = HEAD, color = FILTER) +
ggplot2::geom_point() +
ggplot2::ggtitle(unique(.$NAME))
)
)
test$NAME
test$plots[[1]]
library(devtools)
load_all()
use_package("ggplot2")
document()
fname <- system.file("extdata","export_data_menyanthes.csv",package="menyanthes")
hm <- hm_read_export_csv( fname )
x <- hm_plot(hm)
x <- hm_plot(hm,file.path("~","plots"))
file.path("~","plots")
x <- hm_plot(hm,file.path(path.expand("~"),"plots"))
file.path(path.expand("~"),"plots")
library(devtools)
library(devtools)
load_all()
hm <- hm_rbind(hm1, hm2)
load_all()
hm <- hm_rbind(hm1, hm2)
load_all()
hm <- hm_rbind(hm1, hm2)
load_all()
hm <- hm_rbind(hm1, hm2)
load_all()
hm <- hm_rbind(hm1, hm2)
?lapply
load_all()
hm <- hm_rbind(hm1, hm2)
hm <- hm_rbind(hm1, hm2, hm1)
document()
library(menyanthes)
library(devtools)
load_all()
fname <- system.file("extdata","export_data_menyanthes.csv",package="menyanthes")
con <- file(fname, "r")
x <- readLines(con, 1)
head(x)
if (!(grepl("HydroMonitor - open data exchange file", x, fixed = TRUE))) {
close(con)
stop("This is not a export HydroMonitor - open data exchange file.")
}
# Check if this is not a export HydroMonitor - open data exchange file
i <- 1
is_obs_well_file <- FALSE
while (TRUE) {
x = readLines(con, 1)
found <- grepl("ObservationWell", x, fixed = TRUE)
if ((i == 100) || (found)) {
break
}
i <- i + 1
}
if (!found) {
stop("This is not a export HydroMonitor file with ObservationWell data.")
}
close(con)
con <- file(fname, "r")
x <- readLines(con, warn = FALSE)
close(con)
i <- which(grepl("^;;", x))
# Determine column names of metadata and data
names_xm <- x[i[1] + 1] %>% strsplit(";") %>% unlist()
names_xd <- x[i[2] + 1] %>% strsplit(";") %>% unlist()
names_xm
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
xm
names(xm)
xm$V19 <- NULL
names(xm) <- names_xm
head(xm)
str(xm$SurfaceLevel)
range(xm$SurfaceLevel)
hm <- hm1
hm$xd$FILTER %<>% as.factor()
str(hm)
x <- suppressWarnings(
hm$xd %>% dplyr::group_by(NAME) %>% dplyr::do(
plots = ggplot2::ggplot(data = .) +
ggplot2::aes(x = DATE, y = HEAD, color = FILTER) +
ggplot2::geom_point() +
ggplot2::geom_line() +
ggplot2::ggtitle(unique(.$NAME))
)
)
str(x)
x$NAME
head(hm$xd)
hm$xd %>% dplyr::group_by(NAME) %>% dplyr::do(print(.))
test <- dplyr::full_join(hm$xd,hm$xm, by=c("NAME","FILTER"))
hm <- hm1
test <- dplyr::full_join(hm$xd,hm$xm, by=c("NAME","FILTER"))
str(test)
head(test)
load_all()
?data.frame
load_all()
?do
hm$xm %>% dplyr::group_by(NAME) %>% dplyr::do(mv=data.frame(yintercept=.$MV, MV=factor(.$MV))
)
str(test)
load_all()
load_all()
hm <- hm1
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x$plots[[1]]
hm <- hm1
x <- hm_plot(hm)
x$plots[[1]]
load_all()
hm <- hm1
x <- hm_plot(hm)
x$plots[[1]]
load_all()
hm <- hm1
x <- hm_plot(hm)
x$plots[[1]]
head(hm$xm)
?geom_hline
load_all()
hm <- hm1
x <- hm_plot(hm)
x$plots[[1]]
?annotate
hm <- hm1
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x$plots[[1]]
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
load_all()
x <- hm_plot(hm)
x$plots[[1]]
x$plots[[2]]
head(hm$xm)
head(hm$xm,20)
?menyanthes
test <- hm_rm_dble_fltrs(hm)
head(test,20)
test <- hm_rm_dble_fltrs(hm)
head(test)
head(test$xm,20)
fname <- system.file("extdata","export_data_menyanthes.csv",package="menyanthes")
hm1 <- hm_read_export_csv( fname )
head(hm1,10)
head(hm1$xm,10)
hm1 %<>%hm_rm_dble_fltrs()
head(hm1,10)
head(hm1$xm,10)
fname <- system.file("extdata","export_data_menyanthes.csv",package="menyanthes")
hm1 <- hm_read_export_csv( fname )
hm2
use_data(hm1)
use_data(hm1,overwrite=TRUE)
fname <- system.file("extdata","Topsoil1.csv",package="menyanthes")
hm2 <- hm_read_export_csv2( fname )
use_data(hm2,overwrite=TRUE)
library(menyanthes)
.libPaths()
library(menyanthes)
fname <- system.file("extdata","export_data_menyanthes.csv",package="menyanthes")
hm1 <- hm_read_export_csv( fname )
?use_data
use_data(hm1,internal=TRUE,overwrite=TRUE)
fname <- system.file("extdata","Topsoil1.csv",package="menyanthes")
hm2 <- hm_read_export_csv2( fname )
use_data(hm2,internal=TRUE,overwrite=TRUE)
detach("package:menyanthes", unload = TRUE)
library(menyanthes)
