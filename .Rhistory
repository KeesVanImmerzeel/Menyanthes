library(devtools)
document()
setwd("P:/410/372786_Update_Effectanalyse_Drentse_Weg/2. Do Work/Ontvangen gegevens/Peilbuizen/NieuwePeilbuizen/Grondwaterstanden_Put")
setwd("P:/410/372786_Update_Effectanalyse_Drentse_Weg/2. Do Work/Ontvangen gegevens/Peilbuizen/NieuwePeilbuizen/Grondwaterstanden_Put")
library(stringr)
library(dplyr)
library(lubridate)
library(magrittr)
# Read head from Dinoloket groundwater heads csv file into data frame.
get_heads_df <- function( fname) {
print(fname)
lns <- readLines(fname)
#regelnr_kopgegevens <- which( str_detect(lns,"Externe aanduiding"))
regelnr_kop_stijghoogten <- which( str_detect(lns, "Opmerking") )
i <- regelnr_kop_stijghoogten +1
date_strings <-
sapply(lns[i:length(lns)], function(x) {
s <-
str_split(x, ",") %>% unlist() %>% .[3];
}, simplify=TRUE, USE.NAMES=FALSE)
head_strings <-
sapply(lns[i:length(lns)], function(x) {
s <-
str_split(x, ",") %>% unlist() %>% .[6];
}, simplify=TRUE, USE.NAMES=FALSE)
names_strings <-
sapply(lns[i:length(lns)], function(x) {
s <-
str_split(x, ",") %>% unlist() %>% .[1];
}, simplify=TRUE, USE.NAMES=FALSE)
filters_strings <-
sapply(lns[i:length(lns)], function(x) {
s <-
str_split(x, ",") %>% unlist() %>% .[2];
}, simplify=TRUE, USE.NAMES=FALSE)
dates <- suppressWarnings( date_strings %>% dmy() )
heads <- suppressWarnings( as.numeric(head_strings) / 100 )
names_strings %<>% paste0(filters_strings)
years <- year(dates)
df <- data.frame( Date=dates, Head=heads, Jaar=years, Filter=names_strings )
ok <- complete.cases(df)
df <- df[ok,]
return(df)
}
fnames <- list.files(
path = ".",
pattern = glob2rx("*_01.csv"),
full.names = TRUE,
recursive = TRUE,
ignore.case = TRUE
) %>% as.matrix()
all_heads <- suppressWarnings( apply(fnames, MARGIN = 1, get_heads_df) %>% bind_rows() )
fnames <- list.files(
path = ".",
pattern = glob2rx("*.csv"),
full.names = FALSE,
recursive = TRUE,
ignore.case = TRUE
)
fnames
fname <- "B12C1736001_0.csv"
get_heads_df(fname)
lns <- readLines(fname)
#regelnr_kopgegevens <- which( str_detect(lns,"Externe aanduiding"))
regelnr_kop_stijghoogten <- which( str_detect(lns, "Opmerking") )
regelnr_kop_stijghoogten
lns
?str_detect
str_detect(lns,"Externe aanduiding")
str_detect(lns, "Opmerking,,,")
library(stringi)
stri_detect(lns, "Opmerking")
#regelnr_kopgegevens <- which( str_detect(lns,"Externe aanduiding"))
regelnr_kop_stijghoogten <- which( stringr::str_detect(lns, "Opmerking") )
regelnr_kop_stijghoogten
#regelnr_kopgegevens <- which( str_detect(lns,"Externe aanduiding"))
regelnr_kop_stijghoogten <- which( grepl("Opmerking",lns) )
regelnr_kop_stijghoogten
lns <- "Locatie,Filternummer,Peildatum,Stand (cm t.o.v. MP),Stand (cm t.o.v. MV),Stand (cm t.o.v. NAP),Bijzonderheid,Opmerking,,,"
str_detect(lns, "Opmerking")
#regelnr_kopgegevens <- which( str_detect(lns,"Externe aanduiding"))
regelnr_kop_stijghoogten <- which( str_detect(lns, "Opmerking") )
regelnr_kop_stijghoogten
lns <- readLines(fname)
str(lns)
#regelnr_kopgegevens <- which( str_detect(lns,"Externe aanduiding"))
regelnr_kop_stijghoogten <- which( str_detect(lns, "Opmerking") )
regelnr_kop_stijghoogten
library(devtools)
load_all()
fname <- system.file("extdata","export_data_menyanthes(2).csv",package="menyanthes")
fname
x <- hm_read_export_csv(fname)
con <- file(fname, "r")
x <- readLines(con, 1)
if (!(grepl("HydroMonitor - open data exchange file", x, fixed = TRUE))) {
close(con)
stop("This is not a export HydroMonitor - open data exchange file.")
}
i <- 1
is_obs_well_file <- FALSE
while (TRUE) {
x = readLines(con, 1)
found <- grepl("ObservationWell", x, fixed = TRUE)
if ((i == 100) || (found)) {
break
}
i <- i + 1
}
if (!found) {
stop("This is not a export HydroMonitor file with ObservationWell data.")
}
close(con)
con <- file(fname, "r")
x <- readLines(con, warn = FALSE)
close(con)
i <- which(grepl("^;;", x))
# Determine column names of metadata and data
names_xm <- x[i[1] + 1] %>% strsplit(";") %>% unlist()
names_xd <- x[i[2] + 1] %>% strsplit(";") %>% unlist()
i
names_xm <- x[i[1] + 1] %>% strsplit(";") %>% unlist()
names_xd <- x[i[2] + 1] %>% strsplit(";") %>% unlist()
names_xm
names_xd
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
head(xm)
xm$V19 <- NULL
names(xm) <- names_xm
xm$FilterNo <- suppressWarnings(as.integer(xm$FilterNo))
xm <- xm[!is.na(xm$FilterNo),]
xm$StartDateTime <- lubridate::dmy_hm(xm$StartDateTime)
head(xm)
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
xm$V19 <- NULL
head(xm)
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
head(xm)
xm$V19 <- NULL
names(xm) <- names_xm
head(xm)
names(xm)
xm$FilterNo
head(xm)
xm$FilterNo <- suppressWarnings(as.integer(xm$FilterNo))
head(xm)
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
xm$V19 <- NULL
names(xm) <- names_xm
xm$Name %<>% remove_trailing_letter(.)
xm$FilterNo <- suppressWarnings(as.integer(xm$FilterNo))
head(xm)
x <- "foch1-1"
strsplit(x,"-")
tail(strsplit(x,"-"))
tail(strsplit(x,"-"), n=1)
strsplit(x,"-")
strsplit(x,"-")[2]
strsplit(x,"-")
y <- strsplit(x,"-")
y[2]
str(y)
library(magrittr)
strsplit(x,"-") %>% unlist()
strsplit(x,"-") %>% unlist() %>% .[2]
strsplit(x,"-") %>% unlist() %>% .[length(.)]
strsplit(x,c("-","_") %>% unlist() %>% .[length(.)]
strsplit(x,c("-","_")) %>% unlist() %>% .[length(.)]
head(xm)
xm %>% group_by("Name") %>% mutate(FilterNo=n())
head(xm)
xm %>% group_by("Name") %>% mutate(FilterNo=1:n())
xm[,new:= rowid(Name)]
xm %>% group_by("Name")
xm
xm %>% group_by("Name") %>% mutate(FilterNo=n())
xm %>% group_by("Name") %>% mutate(FilterNo=1:n())
xm %>% group_by("Name") %>% mutate(FilterNo=row_number())
xm %>% group_by("Name") %>% mutate(FilterNo=dplyr::row_number())
xm %>% group_by("Name") %>% mutate(FilterNo=dplyr::row_number())
xm$Name %<>% as.factor(.)
xm %>% group_by("Name") %>% mutate(FilterNo=dplyr::row_number())
xm %>% group_by(Name) %>% mutate(FilterNo=dplyr::row_number())
xm %>% group_by(Name) %>% mutate(flt2=dplyr::row_number()) # Filter numbers guessed when not explicitely specified
xm %<>% group_by(Name) %>% mutate(flt2=dplyr::row_number())
xm$flt2
xm %<>% group_by(Name) %>% mutate(FilterNo=dplyr::row_number())
xm
is.na(flt1)
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
xm$V19 <- NULL
names(xm) <- names_xm
xm$Name %<>% remove_trailing_letter(.)
# Assign filter number
flt1 <- suppressWarnings(as.integer(xm$FilterNo)) # Filter numbers when explicitely specified
flt1
is.na(flt1)
!is.na(flt1)
xm$FilterNo <- flt1[!is.na(flt1)]
# Assign filter number
flt1 <- suppressWarnings(as.integer(xm$FilterNo)) # Filter numbers when explicitely specified
xm %<>% group_by(Name) %>% mutate(FilterNo=dplyr::row_number()) # Filter numbers guessed when not explicitely specified
nrow(xm)
nrow(flt1)
length(flt1)
xm$FilterNo <- flt1[!is.na(flt1)]
str(xm$FilterNo)
str(flt1[!is.na(flt1)])
flt1
str(flt1)
flt1[!is.na(flt1)]
is.na(flt1)
xm$FilterNo <- flt1[is.na(flt1)]
xm$FilterNo <- flt1[!is.na(flt1)]
length(!is.na(flt1))
!is.na(flt1)
flt1[!is.na(flt1)]
flt1[1] <- 1
flt1[!is.na(flt1)]
length(flt1)
flt1
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
xm$V19 <- NULL
names(xm) <- names_xm
xm$Name %<>% remove_trailing_letter(.)
# Assign filter number
flt1 <- suppressWarnings(as.integer(xm$FilterNo))
lenth(flt1)
length(flt1)
flt2 <- flt1[!is.na(flt1)]
flt2
flt1 <- suppressWarnings(as.integer(xm$FilterNo)) # Filter numbers when explicitely specified
flt1_is_specified <- flt1[!is.na(flt1)]
flt1_is_specified
flt1 <- suppressWarnings(as.integer(xm$FilterNo)) # Filter numbers when explicitely specified
flt1_as_specified <- flt1[!is.na(flt1)]
length(flt1_as_specified)
con <- file(fname, "r")
x <- readLines(con, 1)
if (!(grepl("HydroMonitor - open data exchange file", x, fixed = TRUE))) {
close(con)
stop("This is not a export HydroMonitor - open data exchange file.")
}
# Check if this is not a export HydroMonitor - open data exchange file
i <- 1
is_obs_well_file <- FALSE
while (TRUE) {
x = readLines(con, 1)
found <- grepl("ObservationWell", x, fixed = TRUE)
if ((i == 100) || (found)) {
break
}
i <- i + 1
}
if (!found) {
stop("This is not a export HydroMonitor file with ObservationWell data.")
}
close(con)
# Read all lines in the file to determine
con <- file(fname, "r")
x <- readLines(con, warn = FALSE)
close(con)
# Determine start end end line number of metadata and data.
i <- which(grepl("^;;", x))
# Determine column names of metadata and data
names_xm <- x[i[1] + 1] %>% strsplit(";") %>% unlist()
names_xd <- x[i[2] + 1] %>% strsplit(";") %>% unlist()
# Read Metadata
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
xm$V19 <- NULL
names(xm) <- names_xm
xm$Name %<>% remove_trailing_letter(.)
# Assign filter number
flt1 <-
suppressWarnings(as.integer(xm$FilterNo)) # Filter numbers when explicitely specified
flt1_as_specified <- flt1[!is.na(flt1)]
xm %<>% group_by(Name) %>% mutate(FilterNo = dplyr::row_number()) # Filter numbers guessed when not explicitely specified
if (flt1_as_specified > 0) {
xm$FilterNo <- flt1_as_specified
}
xm <- xm[!is.na(xm$FilterNo),]
xm$StartDateTime <- lubridate::dmy_hm(xm$StartDateTime)
con <- file(fname, "r")
x <- readLines(con, 1)
if (!(grepl("HydroMonitor - open data exchange file", x, fixed = TRUE))) {
close(con)
stop("This is not a export HydroMonitor - open data exchange file.")
}
# Check if this is not a export HydroMonitor - open data exchange file
i <- 1
is_obs_well_file <- FALSE
while (TRUE) {
x = readLines(con, 1)
found <- grepl("ObservationWell", x, fixed = TRUE)
if ((i == 100) || (found)) {
break
}
i <- i + 1
}
if (!found) {
stop("This is not a export HydroMonitor file with ObservationWell data.")
}
close(con)
# Read all lines in the file to determine
con <- file(fname, "r")
x <- readLines(con, warn = FALSE)
close(con)
# Determine start end end line number of metadata and data.
i <- which(grepl("^;;", x))
# Determine column names of metadata and data
names_xm <- x[i[1] + 1] %>% strsplit(";") %>% unlist()
names_xd <- x[i[2] + 1] %>% strsplit(";") %>% unlist()
# Read Metadata
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
xm$V19 <- NULL
names(xm) <- names_xm
xm$Name %<>% remove_trailing_letter(.)
# Assign filter number
flt1 <-
suppressWarnings(as.integer(xm$FilterNo)) # Filter numbers when explicitely specified
flt1_as_specified <- flt1[!is.na(flt1)]
xm %<>% group_by(Name) %>% mutate(FilterNo = dplyr::row_number()) # Filter numbers guessed when not explicitely specified
if (length(flt1_as_specified) > 0) {
xm$FilterNo <- flt1_as_specified
}
xm <- xm[!is.na(xm$FilterNo),]
xm$StartDateTime <- lubridate::dmy_hm(xm$StartDateTime)
# Filter meta data on essential information
xm <-
data.frame(
NAME = xm$Name,
FILTER = xm$FilterNo,
X = xm$XCoordinate,
Y = xm$YCoordinate,
TOP = xm$FilterTopLevel,
BOT = xm$FilterBottomLevel,
MV = xm$SurfaceLevel
)
xm %<>% dplyr::arrange(NAME, FILTER)
# Read Data
xd <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[2] + 2,
row.names = NULL
)
xd <- xd[, c(1, 2, 3, 4)]
names(xd) <- c("NAME", "FILTER", "DATE", "HEAD")
xd <- xd[!is.na(xd$FILTER),]
xd$DATE <- lubridate::dmy_hms(xd$DATE)
xd$NAME %<>% remove_trailing_letter(.)
xd <- xd[!is.na(xd$HEAD),] # Remove NA values
con <- file(fname, "r")
x <- readLines(con, 1)
if (!(grepl("HydroMonitor - open data exchange file", x, fixed = TRUE))) {
close(con)
stop("This is not a export HydroMonitor - open data exchange file.")
}
# Check if this is not a export HydroMonitor - open data exchange file
i <- 1
is_obs_well_file <- FALSE
while (TRUE) {
x = readLines(con, 1)
found <- grepl("ObservationWell", x, fixed = TRUE)
if ((i == 100) || (found)) {
break
}
i <- i + 1
}
if (!found) {
stop("This is not a export HydroMonitor file with ObservationWell data.")
}
close(con)
# Read all lines in the file to determine
con <- file(fname, "r")
x <- readLines(con, warn = FALSE)
close(con)
# Determine start end end line number of metadata and data.
i <- which(grepl("^;;", x))
# Determine column names of metadata and data
names_xm <- x[i[1] + 1] %>% strsplit(";") %>% unlist()
names_xd <- x[i[2] + 1] %>% strsplit(";") %>% unlist()
# Read Metadata
xm <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[1] + 2,
row.names = NULL
)
xm$V19 <- NULL
names(xm) <- names_xm
xm$Name %<>% remove_trailing_letter(.)
# Assign filter number
flt1 <-
suppressWarnings(as.integer(xm$FilterNo)) # Filter numbers when explicitely specified
flt1_as_specified <- flt1[!is.na(flt1)]
xm %<>% group_by(Name) %>% mutate(FilterNo = dplyr::row_number()) # Filter numbers guessed when not explicitely specified
if (length(flt1_as_specified) > 0) {
xm$FilterNo <- flt1_as_specified
}
xm <- xm[!is.na(xm$FilterNo),]
xm$StartDateTime <- lubridate::dmy_hm(xm$StartDateTime)
head(xm)
xm <-
data.frame(
NAME = xm$Name,
FILTER = xm$FilterNo,
X = xm$XCoordinate,
Y = xm$YCoordinate,
TOP = xm$FilterTopLevel,
BOT = xm$FilterBottomLevel,
MV = xm$SurfaceLevel
)
xm %<>% dplyr::arrange(NAME, FILTER)
xd <- read.csv2(
fname,
header = FALSE,
sep = ";",
quote = "\"",
fill = TRUE,
skip = i[2] + 2,
row.names = NULL
)
head(xd)
fname
i
i[2] + 2
xd <- xd[, c(1, 2, 3, 4)]
names(xd) <- c("NAME", "FILTER", "DATE", "HEAD")
xd <- xd[!is.na(xd$FILTER),]
xd$DATE <- lubridate::dmy_hms(xd$DATE)
xd$NAME %<>% remove_trailing_letter(.)
xd <- xd[!is.na(xd$HEAD),] # Remove NA values
hm <- list()
hm$xm <- xm
hm$xd <- xd
# Remove double filters and observations
hm %<>% hm_rm_dble_fltrs()
hm %<>% hm_rm_dble_obs()
xd
hm %<>% hm_rm_dble_fltrs()
hm %<>% hm_rm_dble_obs()
